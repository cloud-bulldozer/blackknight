---

- name: Install docker
  package:
    name: docker
    state: present
  ignore_errors: yes

- name: Make sure docker is running
  systemd:
    state: started
    name: docker

- name: Setup docker dir
  file:
    path: ~/.docker
    state: directory

- name: Docker login
  get_url:
    url: "{{ docker_config_url }}"
    dest: ~/.docker/config.json
    force: yes

- name: Add olm
  command: kubectl apply -f {{ olm_url }}
  register: olm_status
  until: olm_status.rc == 0
  delay: 5
  retries: 10
  ignore_errors: yes
  tags: [olm]

- name: Add pull secret for registry.connect.redhat.com
  get_url:
    url: "{{ pull_secret_url }}"
    dest: "{{ pull_secret_destination }}"
    mode: 0755
    force: yes

- name: Setup operator-sdk
  file:
    path: "/root/go/src/github.com/operator-framework"
    state: directory
    recurse: yes

- name: clone operator-sdk
  git:
    repo: 'https://github.com/operator-framework/operator-sdk'
    dest: "/root/go/src/github.com/operator-framework/operator-sdk"
    version: master
    force: yes

- name: get gopath
  command: go env GOPATH
  register: env_gopath

- name: Make dep for operator-sdk
  shell: make dep
  environment:
    PATH: "{{ lookup('env','PATH') }}:{{ env_gopath.stdout }}/bin"
  args:
    chdir: "/root/go/src/github.com/operator-framework/operator-sdk"
  when: env_gopath is succeeded

- name: Install operator-sdk
  shell: make install
  args:
    chdir: "/root/go/src/github.com/operator-framework/operator-sdk"
